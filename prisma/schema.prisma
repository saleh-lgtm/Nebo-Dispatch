// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  SUPER_ADMIN
  ADMIN
  ACCOUNTING
  DISPATCHER
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum RequestType {
  HOURS_MODIFICATION
  SCHEDULE_CHANGE
  REVIEW
  TIME_OFF
  SHIFT_SWAP
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AffiliateType {
  FARM_IN         // Partners that send work to us
  FARM_OUT        // Partners we send work to
  IOS             // Independent Operators (self-employed drivers)
  HOUSE_CHAUFFEUR // In-house company drivers
}

enum ReportStatus {
  DRAFT
  SUBMITTED
  REVIEWED
  FLAGGED
}

enum ApprovalStatus {
  PENDING    // Awaiting admin approval
  APPROVED   // Can access the system
  REJECTED   // Rejected by admin
}

enum RetailLeadOutcome {
  WON
  NEEDS_FOLLOW_UP
  LOST
}

enum LostReason {
  VEHICLE_TYPE
  AVAILABILITY
  PRICING
  OTHER
}

enum AccountingFlagStatus {
  PENDING
  IN_REVIEW
  RESOLVED
}

// Fleet Vehicle Management
enum VehicleType {
  SEDAN
  SUV
  VAN
  BUS
  LIMOUSINE
  STRETCH_LIMO
  SPRINTER
  MINI_BUS
  COACH
  OTHER
}

enum VehicleStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  RETIRED
}

model User {
  id             String          @id @default(cuid())
  name           String?
  email          String?         @unique
  emailVerified  DateTime?
  password       String?
  role           Role            @default(DISPATCHER)
  isActive       Boolean         @default(true)
  approvalStatus ApprovalStatus  @default(PENDING)
  approvedById   String?
  approvedBy     User?           @relation("ApprovedBy", fields: [approvedById], references: [id])
  approvedUsers  User[]          @relation("ApprovedBy")
  approvedAt     DateTime?
  rejectionReason String?
  lastLogin      DateTime?
  loginAttempts  Int             @default(0)
  lockedUntil    DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  // Self-referential relation for user creation tracking
  createdById  String?
  createdBy    User?   @relation("CreatedBy", fields: [createdById], references: [id])
  createdUsers User[]  @relation("CreatedBy")

  shifts          Shift[]
  shiftReports    ShiftReport[]
  reviewedReports ShiftReport[]       @relation("ReviewedReports")
  courtReports    CourtReport[]
  assignedTasks   Task[]              @relation("AssignedDispatcher")
  createdTasks    Task[]              @relation("AssigningAdmin")
  notes           GlobalNote[]
  schedules       Schedule[]
  requests        SchedulingRequest[]
  swapRequests    SchedulingRequest[] @relation("SwapTarget")
  affiliates          Affiliate[]
  auditLogs           AuditLog[]
  passwordResetTokens PasswordResetToken[]
  quotesCreated       Quote[]              @relation("QuotesCreated")
  quotesAssigned      Quote[]              @relation("QuotesAssigned")
  quoteActions        QuoteAction[]
  presence            UserPresence?
  eventsCreated       Event[]
  sopsCreated         SOP[]

  // Time Off and Shift Swap relations
  timeOffRequests     TimeOffRequest[]
  timeOffReviewed     TimeOffRequest[]     @relation("TimeOffReviewer")
  swapRequestsMade    ShiftSwapRequest[]   @relation("SwapRequester")
  swapRequestsReceived ShiftSwapRequest[]  @relation("SwapTarget")
  swapRequestsReviewed ShiftSwapRequest[]  @relation("SwapReviewer")

  // Admin task assignment
  assignedShiftTasks    ShiftTask[]            @relation("TaskAssigner")
  adminTasksCreated     AdminTask[]            @relation("AdminTaskCreator")
  adminTasksAssigned    AdminTask[]            @relation("AdminTaskAssignee")
  adminTaskCompletions  AdminTaskCompletion[]

  // SOP relations
  sopReads              SOPRead[]
  sopFavorites          SOPFavorite[]
  sopVersions           SOPVersion[]
  sopQuizAttempts       SOPQuizAttempt[]

  // Accounting flag relations
  flagsCreated          AccountingFlag[]  @relation("FlaggedBy")
  flagsReviewed         AccountingFlag[]  @relation("ReviewedBy")

  // Notification relations
  notifications         Notification[]

  // SMS Log relations
  smsLogs               SMSLog[]

  // Fleet Vehicle relations
  vehiclesCreated        FleetVehicle[]         @relation("VehicleCreator")
  vehicleDocumentsUploaded VehicleDocument[]    @relation("DocumentUploader")
  affiliateAttachmentsUploaded AffiliateAttachment[] @relation("AffiliateAttachmentUploader")
}

model Shift {
  id         String              @id @default(cuid())
  userId     String
  user       User                @relation(fields: [userId], references: [id])
  clockIn    DateTime            @default(now())
  clockOut   DateTime?
  totalHours Float?

  // Schedule comparison
  scheduledStart DateTime?       // The scheduled start time for comparison
  scheduledEnd   DateTime?       // The scheduled end time for comparison
  earlyClockIn   Int?            // Minutes early (positive) or late (negative)
  earlyClockOut  Int?            // Minutes early (positive) or late (negative)

  // Flag for incomplete report
  incompleteReportFlag Boolean   @default(false)

  reports    ShiftReport[]
  tasks      ShiftTask[]
  requests   SchedulingRequest[]
  quotes     Quote[]
}

model ShiftReport {
  id      String @id @default(cuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id])
  shiftId String
  shift   Shift  @relation(fields: [shiftId], references: [id])

  // Status tracking
  status ReportStatus @default(SUBMITTED)

  // Core metrics
  callsReceived Int @default(0)
  emailsSent    Int @default(0)
  quotesGiven   Int @default(0)

  // Reservation tracking
  acceptedReservations     Json? // [{id: string, notes: string}]
  modifiedReservations     Json? // [{id: string, notes: string}]
  cancelledReservations    Json? // [{id: string, reason: string}]
  totalReservationsHandled Int   @default(0)

  // Customer interaction metrics
  complaintsReceived Int @default(0)
  complaintsResolved Int @default(0)
  escalations        Int @default(0)

  // Driver coordination
  driversDispatched Int @default(0)
  noShowsHandled    Int @default(0)
  latePickups       Int @default(0)

  // Narrative fields
  handoffNotes    String? @db.Text
  generalComments String? @db.Text
  newIdeas        String? @db.Text
  incidents       String? @db.Text
  achievements    String? @db.Text // Notable accomplishments
  challenges      String? @db.Text // Difficulties faced

  // Rating (self-assessment)
  shiftRating Int? // 1-5 self-rating

  // Admin review
  reviewedById     String?
  reviewedBy       User?     @relation("ReviewedReports", fields: [reviewedById], references: [id])
  reviewedAt       DateTime?
  adminFeedback    String?   @db.Text
  performanceScore Int? // Admin-assigned 1-100 score

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Accounting flags
  accountingFlags AccountingFlag[]

  // Retail lead tracking
  retailLeads RetailLead[]

  @@index([userId, createdAt])
  @@index([status])
  @@index([createdAt])
}

// Retail lead tracking for shift reports
model RetailLead {
  id             String            @id @default(cuid())
  shiftReportId  String
  shiftReport    ShiftReport       @relation(fields: [shiftReportId], references: [id], onDelete: Cascade)

  // What the customer requested
  serviceRequested String          @db.Text

  // Outcome tracking
  outcome        RetailLeadOutcome

  // If lost, why?
  lostReason     LostReason?
  lostReasonOther String?          @db.Text  // If lostReason is OTHER

  // Additional notes
  notes          String?           @db.Text

  createdAt      DateTime          @default(now())

  @@index([shiftReportId])
}

model TaskTemplate {
  id          String     @id @default(cuid())
  title       String
  description String?
  category    String? // e.g., "Morning", "Standard"
  isActive    Boolean    @default(true)
  items       TaskItem[]
}

model TaskItem {
  id         String       @id @default(cuid())
  templateId String
  template   TaskTemplate @relation(fields: [templateId], references: [id])
  content    String
  order      Int          @default(0)
}

model ShiftTask {
  id          String    @id @default(cuid())
  shiftId     String
  shift       Shift     @relation(fields: [shiftId], references: [id])
  content     String
  isCompleted Boolean   @default(false)
  startedAt   DateTime? // When task was started
  completedAt DateTime?

  // Admin assignment fields
  assignedById  String?
  assignedBy    User?    @relation("TaskAssigner", fields: [assignedById], references: [id])
  isAdminTask   Boolean  @default(false)
  priority      Int      @default(0)
}

model CourtReport {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  caseDetails String   @db.Text
  actionTaken String   @db.Text
  createdAt   DateTime @default(now())
}

model Schedule {
  id           String              @id @default(cuid())
  userId       String
  user         User                @relation(fields: [userId], references: [id])
  isPublished  Boolean             @default(false)
  shiftStart   DateTime
  shiftEnd     DateTime
  weekStart    DateTime? // Sunday 00:00:00 of the week for efficient queries
  requests     SchedulingRequest[]
  swapRequests SchedulingRequest[] @relation("SwapTargetSchedule")

  // Shift Swap relations
  swapRequestsAsRequester ShiftSwapRequest[] @relation("RequesterShift")
  swapRequestsAsTarget    ShiftSwapRequest[] @relation("TargetShift")

  @@index([weekStart])
  @@index([userId, weekStart])
}

model Affiliate {
  id               String        @id @default(cuid())
  name             String
  email            String
  phone            String?       // Contact phone number
  state            String?       // State (e.g., "TX", "CA") - optional for IOS/Chauffeurs
  cities           String[]      // Cities served in that state
  notes            String?       @db.Text
  cityTransferRate String?       // Pricing/Rate info
  isApproved       Boolean       @default(false)
  type             AffiliateType @default(FARM_OUT)
  isActive         Boolean       @default(true)

  // Fields for IOS (Independent Operators)
  market           String?       // Market/region they operate in

  // Fields for House Chauffeurs
  employeeId       String?       // Internal employee ID

  submittedById String
  submittedBy   User   @relation(fields: [submittedById], references: [id])

  // Pricing grid for FARM_IN affiliates
  pricingGrid   AffiliatePricing[]

  // File attachments
  attachments   AffiliateAttachment[]

  // SMS contacts linked to this affiliate
  smsContacts   SMSContact[]

  // IOS driver's personal vehicle info
  vehicleInfo   DriverVehicle?

  // House Chauffeur schedule preferences
  schedulePrefs SchedulePreferences?

  // House Chauffeur fleet vehicle assignments
  vehicleAssignments VehicleAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([isActive])
  @@index([market])
}

model SchedulingRequest {
  id     String        @id @default(cuid())
  userId String
  user   User          @relation(fields: [userId], references: [id])
  type   RequestType
  status RequestStatus @default(PENDING)
  reason String?       @db.Text

  requestedStart DateTime?
  requestedEnd   DateTime?

  shiftId String?
  shift   Shift?  @relation(fields: [shiftId], references: [id])

  scheduleId String?
  schedule   Schedule? @relation(fields: [scheduleId], references: [id])

  // For TIME_OFF requests
  timeOffType String? // "vacation", "sick", "personal", "other"

  // For SHIFT_SWAP requests
  targetUserId     String?
  targetUser       User?     @relation("SwapTarget", fields: [targetUserId], references: [id])
  targetScheduleId String?
  targetSchedule   Schedule? @relation("SwapTargetSchedule", fields: [targetScheduleId], references: [id])
  targetAccepted   Boolean? // null = pending, true = accepted, false = rejected

  adminNotes String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Task {
  id          String     @id @default(cuid())
  userId      String     @map("assigned_to_id")
  user        User       @relation("AssignedDispatcher", fields: [userId], references: [id])
  adminId     String     @map("created_by_id")
  admin       User       @relation("AssigningAdmin", fields: [adminId], references: [id])
  title       String
  description String?    @db.Text
  status      TaskStatus @default(PENDING)
  dueDate     DateTime?
  createdAt   DateTime   @default(now())
}

model GlobalNote {
  id        String   @id @default(cuid())
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  title     String
  content   String   @db.Text
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String // CREATE, UPDATE, DELETE, LOGIN, APPROVE, REJECT, etc.
  entity    String // User, Schedule, ShiftReport, Affiliate, etc.
  entityId  String?
  details   Json? // Additional context about the action
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([entity, entityId])
  @@index([action, createdAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model Quote {
  id           String      @id @default(cuid())
  clientName   String
  clientEmail  String?
  clientPhone  String?
  serviceType  String      // e.g., "Airport Transfer", "Hourly", "City Tour"
  pickupDate   DateTime?
  pickupLocation String?
  dropoffLocation String?
  estimatedAmount Float?
  notes        String?     @db.Text
  status       QuoteStatus @default(PENDING)

  // NEW: Source and service date
  source          String?   // e.g., "Phone", "Email", "Website", "Walk-in", "Referral"
  dateOfService   DateTime? // When the service is needed

  // Follow-up tracking
  followUpCount Int       @default(0)
  lastFollowUp  DateTime?
  nextFollowUp  DateTime?
  followUpNotes String?   @db.Text

  // NEW: Action tracking
  lastActionAt  DateTime? // Last time any action was taken
  actionCount   Int       @default(0)
  isFlagged     Boolean   @default(false) // Flagged if no action taken

  // NEW: Expiration (72 hours after creation)
  expiresAt     DateTime  // Auto-set to 72 hours after creation

  // Conversion tracking
  convertedAt   DateTime?
  reservationId String?   // Link to reservation if converted

  // NEW: Outcome tracking
  outcome       QuoteOutcome? // WON, LOST, or null if pending
  outcomeReason String?      @db.Text // Reason for outcome
  outcomeAt     DateTime?

  // Creator
  createdById   String
  createdBy     User      @relation("QuotesCreated", fields: [createdById], references: [id])

  // Assigned follower (could be different from creator)
  assignedToId  String?
  assignedTo    User?     @relation("QuotesAssigned", fields: [assignedToId], references: [id])

  // Link to shift when quote was created
  shiftId       String?
  shift         Shift?    @relation(fields: [shiftId], references: [id])

  // Quote action history
  actions       QuoteAction[]

  // SMS contacts linked to this quote's client
  smsContacts   SMSContact[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status, createdAt])
  @@index([assignedToId])
  @@index([nextFollowUp])
  @@index([shiftId])
  @@index([expiresAt])
  @@index([isFlagged])
  @@index([lastActionAt])
}

// Track all actions/updates on a quote
model QuoteAction {
  id          String           @id @default(cuid())
  quoteId     String
  quote       Quote            @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  userId      String
  user        User             @relation(fields: [userId], references: [id])
  actionType  QuoteActionType
  notes       String?          @db.Text
  metadata    Json?            // Additional data about the action
  createdAt   DateTime         @default(now())

  @@index([quoteId, createdAt])
  @@index([userId])
}

enum QuoteActionType {
  CREATED       // Quote was created
  CALLED        // Called the client
  EMAILED       // Emailed the client
  TEXTED        // Texted the client
  FOLLOW_UP     // General follow-up
  NOTE_ADDED    // Added a note
  REASSIGNED    // Quote was reassigned
  STATUS_CHANGE // Status was changed
  OUTCOME_SET   // Outcome (won/lost) was recorded
}

enum QuoteOutcome {
  WON   // Quote converted to booking
  LOST  // Quote lost to competitor or customer declined
}

enum QuoteStatus {
  PENDING       // New quote, needs follow-up
  FOLLOWING_UP  // Active follow-up in progress
  CONVERTED     // Successfully converted to booking
  LOST          // Customer went elsewhere
  EXPIRED       // No response after follow-ups
}

enum TimeOffStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ShiftSwapStatus {
  PENDING_TARGET
  PENDING_ADMIN
  APPROVED
  REJECTED
  CANCELLED
}

enum EventType {
  GAME_DAY      // Sports events
  CONCERT       // Concerts/shows
  CONFERENCE    // Business conferences
  HOLIDAY       // Holidays
  PROMOTION     // Company promotions
  GENERAL       // Other events
}

model Event {
  id          String      @id @default(cuid())
  title       String
  description String?     @db.Text
  eventDate   DateTime
  endDate     DateTime?   // Optional for multi-day events
  eventType   EventType   @default(GENERAL)
  location    String?
  notes       String?     @db.Text

  // Operational metadata
  expectedVolume    String?   // "HIGH", "MEDIUM", "LOW"
  staffingNotes     String?   @db.Text

  // Creator
  createdById String
  createdBy   User        @relation(fields: [createdById], references: [id])

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([eventDate])
  @@index([createdById])
}

model UserPresence {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  isOnline     Boolean  @default(false)
  lastSeenAt   DateTime @default(now())
  currentPage  String?  // Track which page user is on

  @@index([isOnline])
  @@index([lastSeenAt])
}

model TimeOffRequest {
  id          String        @id @default(cuid())
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  startDate   DateTime
  endDate     DateTime
  reason      String        @db.Text
  type        String        // VACATION, SICK, PERSONAL, OTHER
  status      TimeOffStatus @default(PENDING)
  reviewedById String?
  reviewedBy   User?        @relation("TimeOffReviewer", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?
  adminNotes   String?      @db.Text
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([userId, status])
  @@index([startDate, endDate])
  @@index([status])
}

model ShiftSwapRequest {
  id              String          @id @default(cuid())
  requesterId     String
  requester       User            @relation("SwapRequester", fields: [requesterId], references: [id])
  targetUserId    String
  targetUser      User            @relation("SwapTarget", fields: [targetUserId], references: [id])
  requesterShiftId String
  requesterShift   Schedule       @relation("RequesterShift", fields: [requesterShiftId], references: [id])
  targetShiftId    String
  targetShift      Schedule       @relation("TargetShift", fields: [targetShiftId], references: [id])
  status          ShiftSwapStatus @default(PENDING_TARGET)
  reason          String?         @db.Text
  targetResponse  String?         @db.Text
  reviewedById    String?
  reviewedBy      User?          @relation("SwapReviewer", fields: [reviewedById], references: [id])
  reviewedAt      DateTime?
  adminNotes      String?        @db.Text
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([requesterId, status])
  @@index([targetUserId, status])
  @@index([status])
}

// Admin-assigned tasks for dispatchers
model AdminTask {
  id           String    @id @default(cuid())
  title        String
  description  String?   @db.Text
  assignToAll  Boolean   @default(false)  // If true, assign to all dispatchers
  assignedToId String?                    // null if assignToAll=true
  assignedTo   User?     @relation("AdminTaskAssignee", fields: [assignedToId], references: [id])
  createdById  String
  createdBy    User      @relation("AdminTaskCreator", fields: [createdById], references: [id])
  isActive     Boolean   @default(true)
  priority     Int       @default(0)
  dueDate      DateTime?                  // Optional due date for the task
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Track completions by users
  completions  AdminTaskCompletion[]

  @@index([isActive, createdAt])
  @@index([assignedToId])
  @@index([dueDate])
}

// Track task completions per user
model AdminTaskCompletion {
  id          String    @id @default(cuid())
  taskId      String
  task        AdminTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  completedAt DateTime  @default(now())
  notes       String?   @db.Text  // Optional completion notes

  @@unique([taskId, userId])  // Each user can only complete a task once
  @@index([userId])
  @@index([taskId])
}

// Standard Operating Procedures (SOPs)
model SOP {
  id          String    @id @default(cuid())
  title       String
  slug        String    @unique // URL-friendly identifier
  description String?   @db.Text // Brief description shown in list
  content     String    @db.Text // Full SOP content (markdown supported)
  category    String?   // e.g., "Customer Service", "Operations", "Safety"
  isPublished Boolean   @default(true)
  order       Int       @default(0) // For manual ordering

  // Quick reference mode - condensed key steps
  quickReference String?  @db.Text

  // Acknowledgment required
  requiresAcknowledgment Boolean @default(false)

  // Creator/Editor
  createdById String
  createdBy   User      @relation(fields: [createdById], references: [id])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  reads       SOPRead[]
  favorites   SOPFavorite[]
  versions    SOPVersion[]
  relatedFrom SOPRelated[] @relation("RelatedFrom")
  relatedTo   SOPRelated[] @relation("RelatedTo")
  quiz        SOPQuiz?

  @@index([isPublished, order])
  @@index([category])
  @@index([slug])
}

// Track who has read/acknowledged an SOP
model SOPRead {
  id        String   @id @default(cuid())
  sopId     String
  sop       SOP      @relation(fields: [sopId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  readAt    DateTime @default(now())
  acknowledged Boolean @default(false)
  acknowledgedAt DateTime?

  @@unique([sopId, userId])
  @@index([sopId])
  @@index([userId])
}

// User favorites/bookmarks
model SOPFavorite {
  id        String   @id @default(cuid())
  sopId     String
  sop       SOP      @relation(fields: [sopId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@unique([sopId, userId])
  @@index([userId])
}

// Version history for SOPs
model SOPVersion {
  id          String   @id @default(cuid())
  sopId       String
  sop         SOP      @relation(fields: [sopId], references: [id], onDelete: Cascade)

  version     Int
  title       String
  content     String   @db.Text
  description String?  @db.Text
  quickReference String? @db.Text

  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])

  changeNote  String?
  createdAt   DateTime @default(now())

  @@unique([sopId, version])
  @@index([sopId])
}

// Link related SOPs together
model SOPRelated {
  id        String   @id @default(cuid())
  fromSopId String
  fromSop   SOP      @relation("RelatedFrom", fields: [fromSopId], references: [id], onDelete: Cascade)
  toSopId   String
  toSop     SOP      @relation("RelatedTo", fields: [toSopId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([fromSopId, toSopId])
  @@index([fromSopId])
  @@index([toSopId])
}

// Quiz for an SOP
model SOPQuiz {
  id        String   @id @default(cuid())
  sopId     String   @unique
  sop       SOP      @relation(fields: [sopId], references: [id], onDelete: Cascade)

  title     String?
  passingScore Int   @default(80)
  isActive  Boolean  @default(true)

  questions SOPQuizQuestion[]
  attempts  SOPQuizAttempt[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Quiz questions
model SOPQuizQuestion {
  id        String   @id @default(cuid())
  quizId    String
  quiz      SOPQuiz  @relation(fields: [quizId], references: [id], onDelete: Cascade)

  question  String   @db.Text
  options   String   @db.Text
  correctAnswer Int
  explanation String? @db.Text
  order     Int      @default(0)

  createdAt DateTime @default(now())

  @@index([quizId])
}

// Quiz attempts by users
model SOPQuizAttempt {
  id        String   @id @default(cuid())
  quizId    String
  quiz      SOPQuiz  @relation(fields: [quizId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  score     Int
  passed    Boolean
  answers   String   @db.Text

  startedAt  DateTime @default(now())
  completedAt DateTime?

  @@index([quizId])
  @@index([userId])
}

// Accounting flag for reservations that need review
model AccountingFlag {
  id              String              @id @default(cuid())
  shiftReportId   String
  shiftReport     ShiftReport         @relation(fields: [shiftReportId], references: [id], onDelete: Cascade)
  reservationType String              // "accepted" | "modified" | "cancelled"
  reservationId   String
  reservationNotes String?            @db.Text

  flaggedById     String
  flaggedBy       User                @relation("FlaggedBy", fields: [flaggedById], references: [id])
  flagReason      String?             @db.Text

  status          AccountingFlagStatus @default(PENDING)
  reviewedById    String?
  reviewedBy      User?               @relation("ReviewedBy", fields: [reviewedById], references: [id])
  reviewedAt      DateTime?
  accountingNotes String?             @db.Text
  resolution      String?             @db.Text

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@unique([shiftReportId, reservationType, reservationId])
  @@index([status])
  @@index([shiftReportId])
  @@index([flaggedById])
}

// Pricing grid for FARM_IN affiliates
model AffiliatePricing {
  id           String    @id @default(cuid())
  affiliateId  String
  affiliate    Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  serviceType  String    // "Airport Transfer", "Hourly Service", etc.
  flatRate     Float
  notes        String?   @db.Text

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([affiliateId, serviceType])
  @@index([affiliateId])
}

// Notification types
enum NotificationType {
  SHIFT_SWAP_REQUEST     // Someone requested to swap shifts with you
  SHIFT_SWAP_RESPONSE    // Someone responded to your swap request
  SHIFT_SWAP_APPROVED    // Admin approved the swap
  SHIFT_SWAP_REJECTED    // Admin rejected the swap
  TIME_OFF_APPROVED      // Time off was approved
  TIME_OFF_REJECTED      // Time off was rejected
  TASK_ASSIGNED          // New task was assigned to you
  TASK_DUE_SOON          // Task is due soon
  SCHEDULE_PUBLISHED     // New schedule was published
  SOP_REQUIRES_ACK       // SOP requires your acknowledgment
  GENERAL                // General notification
}

// User notifications
model Notification {
  id           String           @id @default(cuid())
  userId       String
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type         NotificationType
  title        String
  message      String           @db.Text

  // Link to related entity
  entityType   String?          // "ShiftSwapRequest", "TimeOffRequest", "AdminTask", etc.
  entityId     String?          // ID of the related entity

  // Action URL (where to navigate when clicked)
  actionUrl    String?

  // Read status
  isRead       Boolean          @default(false)
  readAt       DateTime?

  createdAt    DateTime         @default(now())

  @@index([userId, isRead, createdAt])
  @@index([userId, createdAt])
  @@index([entityType, entityId])
}

// SMS Message Direction
enum SMSDirection {
  INBOUND   // Received from customer
  OUTBOUND  // Sent to customer
}

// SMS Contact - Links phone numbers to entities (Affiliates, Quotes, etc.)
model SMSContact {
  id          String   @id @default(cuid())
  phoneNumber String   @unique // E.164 format phone number
  name        String?  // Display name for the contact

  // Entity linking - only one should be set
  affiliateId String?
  affiliate   Affiliate? @relation(fields: [affiliateId], references: [id])
  quoteId     String?
  quote       Quote?     @relation(fields: [quoteId], references: [id])

  // Custom contacts (not linked to any entity)
  customLabel String?  // e.g., "VIP Customer", "Vendor", etc.
  notes       String?  @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // SMS messages linked to this contact
  messages    SMSLog[]

  @@index([affiliateId])
  @@index([quoteId])
}

// SMS Log for tracking Twilio messages
model SMSLog {
  id          String       @id @default(cuid())
  direction   SMSDirection @default(OUTBOUND)
  from        String?      // Sender phone number (for inbound, this is customer)
  to          String       // Recipient phone number
  message     String       @db.Text
  status      String       // queued, sent, delivered, failed, received, etc.
  messageSid  String?      // Twilio message SID
  segments    Int          @default(1) // Number of SMS segments
  error       String?      @db.Text // Error message if failed

  // Optional: link to user who sent it (for outbound)
  sentById    String?
  sentBy      User?        @relation(fields: [sentById], references: [id])

  // For threading conversations by phone number
  conversationPhone String? // Normalized phone number for conversation grouping

  // Link to contact (auto-resolved from phone number)
  contactId   String?
  contact     SMSContact?  @relation(fields: [contactId], references: [id])

  createdAt   DateTime @default(now())

  @@index([status, createdAt])
  @@index([to])
  @@index([from])
  @@index([sentById])
  @@index([conversationPhone, createdAt])
  @@index([contactId])
}

// SMS Opt-Out tracking for compliance
model SMSOptOut {
  id          String    @id @default(cuid())
  phoneNumber String    @unique // E.164 format phone number
  optedOutAt  DateTime? // When user opted out
  optedInAt   DateTime? // When user opted back in (null = still opted out)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([phoneNumber])
}

// ============================================
// FLEET VEHICLE MANAGEMENT
// ============================================

model FleetVehicle {
  id              String        @id @default(cuid())
  name            String        // Display name (e.g., "Black SUV #1")
  type            VehicleType
  status          VehicleStatus @default(ACTIVE)

  // Vehicle Details
  make            String        // e.g., "Cadillac"
  model           String        // e.g., "Escalade"
  year            Int           // e.g., 2024
  color           String?
  licensePlate    String        @unique
  vin             String        @unique

  // Capacity
  passengerCapacity Int?
  luggageCapacity   Int?

  // Notes
  notes           String?       @db.Text

  // Relations
  permits         VehiclePermit[]
  insurance       VehicleInsurance[]
  registration    VehicleRegistration[]
  documents       VehicleDocument[]

  // House Chauffeur assignments
  chauffeurAssignments VehicleAssignment[]

  // Tracking
  createdById     String
  createdBy       User          @relation("VehicleCreator", fields: [createdById], references: [id])

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([status])
  @@index([type])
  @@index([licensePlate])
}

model VehiclePermit {
  id              String       @id @default(cuid())
  vehicleId       String
  vehicle         FleetVehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  permitType      String        // e.g., "TCP", "Airport Permit", "City Permit"
  permitNumber    String?
  issuingAuthority String?
  issueDate       DateTime?
  expirationDate  DateTime

  // File attachment
  fileUrl         String?       // Supabase Storage URL
  fileName        String?
  fileSize        Int?          // bytes

  notes           String?       @db.Text

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([vehicleId])
  @@index([expirationDate])
}

model VehicleInsurance {
  id              String       @id @default(cuid())
  vehicleId       String
  vehicle         FleetVehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  insuranceType   String        // e.g., "Liability", "Comprehensive", "Commercial"
  provider        String        // Insurance company
  policyNumber    String?
  coverageAmount  Float?
  issueDate       DateTime?
  expirationDate  DateTime

  // File attachment
  fileUrl         String?       // Supabase Storage URL
  fileName        String?
  fileSize        Int?

  notes           String?       @db.Text

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([vehicleId])
  @@index([expirationDate])
}

model VehicleRegistration {
  id              String       @id @default(cuid())
  vehicleId       String
  vehicle         FleetVehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  state           String        // Registration state
  registrationNumber String?
  issueDate       DateTime?
  expirationDate  DateTime

  // File attachment
  fileUrl         String?
  fileName        String?
  fileSize        Int?

  notes           String?       @db.Text

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([vehicleId])
  @@index([expirationDate])
}

// General documents for vehicles (maintenance records, inspection reports, etc.)
model VehicleDocument {
  id              String       @id @default(cuid())
  vehicleId       String
  vehicle         FleetVehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  documentType    String        // e.g., "Maintenance Record", "Inspection Report"
  title           String
  description     String?       @db.Text

  // File attachment
  fileUrl         String
  fileName        String
  fileSize        Int?
  mimeType        String?

  uploadedById    String
  uploadedBy      User          @relation("DocumentUploader", fields: [uploadedById], references: [id])

  createdAt       DateTime      @default(now())

  @@index([vehicleId])
  @@index([documentType])
}

// ============================================
// AFFILIATE ATTACHMENTS
// ============================================

model AffiliateAttachment {
  id              String    @id @default(cuid())
  affiliateId     String
  affiliate       Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  title           String
  description     String?   @db.Text
  documentType    String?   // e.g., "Contract", "W-9", "Insurance Certificate"

  // File details
  fileUrl         String
  fileName        String
  fileSize        Int?
  mimeType        String?

  uploadedById    String
  uploadedBy      User      @relation("AffiliateAttachmentUploader", fields: [uploadedById], references: [id])

  createdAt       DateTime  @default(now())

  @@index([affiliateId])
  @@index([documentType])
}

// ============================================
// NETWORK PARTNER EXTENSIONS (IOS & House Chauffeurs)
// ============================================

// Vehicle info for IOS drivers (their own personal vehicles)
model DriverVehicle {
  id              String    @id @default(cuid())
  affiliateId     String    @unique
  affiliate       Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  vehicleType     String?   // Sedan, SUV, Van, etc.
  make            String?
  model           String?
  year            Int?
  color           String?
  licensePlate    String?

  // Additional info
  passengerCapacity Int?
  insuranceExpiry   DateTime?
  notes             String?   @db.Text

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([affiliateId])
}

// Schedule preferences for House Chauffeurs
model SchedulePreferences {
  id              String    @id @default(cuid())
  affiliateId     String    @unique
  affiliate       Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  preferredDays   String[]  // ["Monday", "Tuesday", etc.]
  preferredShifts String[]  // ["Morning", "Evening", "Night"]
  maxHoursWeek    Int?
  timezone        String?   // e.g., "America/Chicago"
  notes           String?   @db.Text

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([affiliateId])
}

// Vehicle assignments - links House Chauffeurs to FleetVehicles
model VehicleAssignment {
  id              String       @id @default(cuid())
  affiliateId     String
  affiliate       Affiliate    @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  vehicleId       String
  vehicle         FleetVehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  startDate       DateTime
  endDate         DateTime?
  isPrimary       Boolean      @default(false)
  notes           String?      @db.Text

  createdAt       DateTime     @default(now())

  @@index([affiliateId])
  @@index([vehicleId])
  @@index([startDate, endDate])
}
