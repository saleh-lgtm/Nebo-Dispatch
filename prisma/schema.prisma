// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  SUPER_ADMIN
  ADMIN
  DISPATCHER
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum RequestType {
  HOURS_MODIFICATION
  SCHEDULE_CHANGE
  REVIEW
  TIME_OFF
  SHIFT_SWAP
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AffiliateType {
  FARM_IN   // Partners that send work to us
  FARM_OUT  // Partners we send work to
}

enum ReportStatus {
  DRAFT
  SUBMITTED
  REVIEWED
  FLAGGED
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  password      String?
  role          Role      @default(DISPATCHER)
  isActive      Boolean   @default(true)
  lastLogin     DateTime?
  loginAttempts Int       @default(0)
  lockedUntil   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Self-referential relation for user creation tracking
  createdById  String?
  createdBy    User?   @relation("CreatedBy", fields: [createdById], references: [id])
  createdUsers User[]  @relation("CreatedBy")

  shifts          Shift[]
  shiftReports    ShiftReport[]
  reviewedReports ShiftReport[]       @relation("ReviewedReports")
  courtReports    CourtReport[]
  assignedTasks   Task[]              @relation("AssignedDispatcher")
  createdTasks    Task[]              @relation("AssigningAdmin")
  notes           GlobalNote[]
  schedules       Schedule[]
  requests        SchedulingRequest[]
  swapRequests    SchedulingRequest[] @relation("SwapTarget")
  affiliates          Affiliate[]
  auditLogs           AuditLog[]
  passwordResetTokens PasswordResetToken[]
  quotesCreated       Quote[]              @relation("QuotesCreated")
  quotesAssigned      Quote[]              @relation("QuotesAssigned")
  quoteActions        QuoteAction[]
  presence            UserPresence?
  eventsCreated       Event[]
  sopsCreated         SOP[]

  // Time Off and Shift Swap relations
  timeOffRequests     TimeOffRequest[]
  timeOffReviewed     TimeOffRequest[]     @relation("TimeOffReviewer")
  swapRequestsMade    ShiftSwapRequest[]   @relation("SwapRequester")
  swapRequestsReceived ShiftSwapRequest[]  @relation("SwapTarget")
  swapRequestsReviewed ShiftSwapRequest[]  @relation("SwapReviewer")

  // Admin task assignment
  assignedShiftTasks    ShiftTask[]            @relation("TaskAssigner")
  adminTasksCreated     AdminTask[]            @relation("AdminTaskCreator")
  adminTasksAssigned    AdminTask[]            @relation("AdminTaskAssignee")
  adminTaskCompletions  AdminTaskCompletion[]

  // SOP relations
  sopReads              SOPRead[]
  sopFavorites          SOPFavorite[]
  sopVersions           SOPVersion[]
  sopQuizAttempts       SOPQuizAttempt[]
}

model Shift {
  id         String              @id @default(cuid())
  userId     String
  user       User                @relation(fields: [userId], references: [id])
  clockIn    DateTime            @default(now())
  clockOut   DateTime?
  totalHours Float?
  reports    ShiftReport[]
  tasks      ShiftTask[]
  requests   SchedulingRequest[]
  quotes     Quote[]
}

model ShiftReport {
  id      String @id @default(cuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id])
  shiftId String
  shift   Shift  @relation(fields: [shiftId], references: [id])

  // Status tracking
  status ReportStatus @default(SUBMITTED)

  // Core metrics
  callsReceived Int @default(0)
  emailsSent    Int @default(0)
  quotesGiven   Int @default(0)

  // Reservation tracking
  acceptedReservations     Json? // [{id: string, notes: string}]
  modifiedReservations     Json? // [{id: string, notes: string}]
  cancelledReservations    Json? // [{id: string, reason: string}]
  totalReservationsHandled Int   @default(0)

  // Customer interaction metrics
  complaintsReceived Int @default(0)
  complaintsResolved Int @default(0)
  escalations        Int @default(0)

  // Driver coordination
  driversDispatched Int @default(0)
  noShowsHandled    Int @default(0)
  latePickups       Int @default(0)

  // Narrative fields
  handoffNotes    String? @db.Text
  generalComments String? @db.Text
  newIdeas        String? @db.Text
  incidents       String? @db.Text
  achievements    String? @db.Text // Notable accomplishments
  challenges      String? @db.Text // Difficulties faced

  // Rating (self-assessment)
  shiftRating Int? // 1-5 self-rating

  // Admin review
  reviewedById     String?
  reviewedBy       User?     @relation("ReviewedReports", fields: [reviewedById], references: [id])
  reviewedAt       DateTime?
  adminFeedback    String?   @db.Text
  performanceScore Int? // Admin-assigned 1-100 score

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([status])
  @@index([createdAt])
}

model TaskTemplate {
  id          String     @id @default(cuid())
  title       String
  description String?
  category    String? // e.g., "Morning", "Standard"
  isActive    Boolean    @default(true)
  items       TaskItem[]
}

model TaskItem {
  id         String       @id @default(cuid())
  templateId String
  template   TaskTemplate @relation(fields: [templateId], references: [id])
  content    String
  order      Int          @default(0)
}

model ShiftTask {
  id          String    @id @default(cuid())
  shiftId     String
  shift       Shift     @relation(fields: [shiftId], references: [id])
  content     String
  isCompleted Boolean   @default(false)
  startedAt   DateTime? // When task was started
  completedAt DateTime?

  // Admin assignment fields
  assignedById  String?
  assignedBy    User?    @relation("TaskAssigner", fields: [assignedById], references: [id])
  isAdminTask   Boolean  @default(false)
  priority      Int      @default(0)
}

model CourtReport {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  caseDetails String   @db.Text
  actionTaken String   @db.Text
  createdAt   DateTime @default(now())
}

model Schedule {
  id           String              @id @default(cuid())
  userId       String
  user         User                @relation(fields: [userId], references: [id])
  isPublished  Boolean             @default(false)
  shiftStart   DateTime
  shiftEnd     DateTime
  weekStart    DateTime? // Sunday 00:00:00 of the week for efficient queries
  requests     SchedulingRequest[]
  swapRequests SchedulingRequest[] @relation("SwapTargetSchedule")

  // Shift Swap relations
  swapRequestsAsRequester ShiftSwapRequest[] @relation("RequesterShift")
  swapRequestsAsTarget    ShiftSwapRequest[] @relation("TargetShift")

  @@index([weekStart])
  @@index([userId, weekStart])
}

model Affiliate {
  id               String        @id @default(cuid())
  name             String
  email            String
  phone            String?       // Contact phone number
  state            String        // State (e.g., "TX", "CA")
  cities           String[]      // Cities served in that state
  notes            String?       @db.Text
  cityTransferRate String?       // Pricing/Rate info
  isApproved       Boolean       @default(false)
  type             AffiliateType @default(FARM_OUT)

  submittedById String
  submittedBy   User   @relation(fields: [submittedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SchedulingRequest {
  id     String        @id @default(cuid())
  userId String
  user   User          @relation(fields: [userId], references: [id])
  type   RequestType
  status RequestStatus @default(PENDING)
  reason String?       @db.Text

  requestedStart DateTime?
  requestedEnd   DateTime?

  shiftId String?
  shift   Shift?  @relation(fields: [shiftId], references: [id])

  scheduleId String?
  schedule   Schedule? @relation(fields: [scheduleId], references: [id])

  // For TIME_OFF requests
  timeOffType String? // "vacation", "sick", "personal", "other"

  // For SHIFT_SWAP requests
  targetUserId     String?
  targetUser       User?     @relation("SwapTarget", fields: [targetUserId], references: [id])
  targetScheduleId String?
  targetSchedule   Schedule? @relation("SwapTargetSchedule", fields: [targetScheduleId], references: [id])
  targetAccepted   Boolean? // null = pending, true = accepted, false = rejected

  adminNotes String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Task {
  id          String     @id @default(cuid())
  userId      String     @map("assigned_to_id")
  user        User       @relation("AssignedDispatcher", fields: [userId], references: [id])
  adminId     String     @map("created_by_id")
  admin       User       @relation("AssigningAdmin", fields: [adminId], references: [id])
  title       String
  description String?    @db.Text
  status      TaskStatus @default(PENDING)
  dueDate     DateTime?
  createdAt   DateTime   @default(now())
}

model GlobalNote {
  id        String   @id @default(cuid())
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  title     String
  content   String   @db.Text
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String // CREATE, UPDATE, DELETE, LOGIN, APPROVE, REJECT, etc.
  entity    String // User, Schedule, ShiftReport, Affiliate, etc.
  entityId  String?
  details   Json? // Additional context about the action
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([entity, entityId])
  @@index([action, createdAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model Quote {
  id           String      @id @default(cuid())
  clientName   String
  clientEmail  String?
  clientPhone  String?
  serviceType  String      // e.g., "Airport Transfer", "Hourly", "City Tour"
  pickupDate   DateTime?
  pickupLocation String?
  dropoffLocation String?
  estimatedAmount Float?
  notes        String?     @db.Text
  status       QuoteStatus @default(PENDING)

  // NEW: Source and service date
  source          String?   // e.g., "Phone", "Email", "Website", "Walk-in", "Referral"
  dateOfService   DateTime? // When the service is needed

  // Follow-up tracking
  followUpCount Int       @default(0)
  lastFollowUp  DateTime?
  nextFollowUp  DateTime?
  followUpNotes String?   @db.Text

  // NEW: Action tracking
  lastActionAt  DateTime? // Last time any action was taken
  actionCount   Int       @default(0)
  isFlagged     Boolean   @default(false) // Flagged if no action taken

  // NEW: Expiration (72 hours after creation)
  expiresAt     DateTime  // Auto-set to 72 hours after creation

  // Conversion tracking
  convertedAt   DateTime?
  reservationId String?   // Link to reservation if converted

  // NEW: Outcome tracking
  outcome       QuoteOutcome? // WON, LOST, or null if pending
  outcomeReason String?      @db.Text // Reason for outcome
  outcomeAt     DateTime?

  // Creator
  createdById   String
  createdBy     User      @relation("QuotesCreated", fields: [createdById], references: [id])

  // Assigned follower (could be different from creator)
  assignedToId  String?
  assignedTo    User?     @relation("QuotesAssigned", fields: [assignedToId], references: [id])

  // Link to shift when quote was created
  shiftId       String?
  shift         Shift?    @relation(fields: [shiftId], references: [id])

  // Quote action history
  actions       QuoteAction[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status, createdAt])
  @@index([assignedToId])
  @@index([nextFollowUp])
  @@index([shiftId])
  @@index([expiresAt])
  @@index([isFlagged])
  @@index([lastActionAt])
}

// Track all actions/updates on a quote
model QuoteAction {
  id          String           @id @default(cuid())
  quoteId     String
  quote       Quote            @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  userId      String
  user        User             @relation(fields: [userId], references: [id])
  actionType  QuoteActionType
  notes       String?          @db.Text
  metadata    Json?            // Additional data about the action
  createdAt   DateTime         @default(now())

  @@index([quoteId, createdAt])
  @@index([userId])
}

enum QuoteActionType {
  CREATED       // Quote was created
  CALLED        // Called the client
  EMAILED       // Emailed the client
  TEXTED        // Texted the client
  FOLLOW_UP     // General follow-up
  NOTE_ADDED    // Added a note
  REASSIGNED    // Quote was reassigned
  STATUS_CHANGE // Status was changed
  OUTCOME_SET   // Outcome (won/lost) was recorded
}

enum QuoteOutcome {
  WON   // Quote converted to booking
  LOST  // Quote lost to competitor or customer declined
}

enum QuoteStatus {
  PENDING       // New quote, needs follow-up
  FOLLOWING_UP  // Active follow-up in progress
  CONVERTED     // Successfully converted to booking
  LOST          // Customer went elsewhere
  EXPIRED       // No response after follow-ups
}

enum TimeOffStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ShiftSwapStatus {
  PENDING_TARGET
  PENDING_ADMIN
  APPROVED
  REJECTED
  CANCELLED
}

enum EventType {
  GAME_DAY      // Sports events
  CONCERT       // Concerts/shows
  CONFERENCE    // Business conferences
  HOLIDAY       // Holidays
  PROMOTION     // Company promotions
  GENERAL       // Other events
}

model Event {
  id          String      @id @default(cuid())
  title       String
  description String?     @db.Text
  eventDate   DateTime
  endDate     DateTime?   // Optional for multi-day events
  eventType   EventType   @default(GENERAL)
  location    String?
  notes       String?     @db.Text

  // Operational metadata
  expectedVolume    String?   // "HIGH", "MEDIUM", "LOW"
  staffingNotes     String?   @db.Text

  // Creator
  createdById String
  createdBy   User        @relation(fields: [createdById], references: [id])

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([eventDate])
  @@index([createdById])
}

model UserPresence {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  isOnline     Boolean  @default(false)
  lastSeenAt   DateTime @default(now())
  currentPage  String?  // Track which page user is on

  @@index([isOnline])
  @@index([lastSeenAt])
}

model TimeOffRequest {
  id          String        @id @default(cuid())
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  startDate   DateTime
  endDate     DateTime
  reason      String        @db.Text
  type        String        // VACATION, SICK, PERSONAL, OTHER
  status      TimeOffStatus @default(PENDING)
  reviewedById String?
  reviewedBy   User?        @relation("TimeOffReviewer", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?
  adminNotes   String?      @db.Text
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([userId, status])
  @@index([startDate, endDate])
  @@index([status])
}

model ShiftSwapRequest {
  id              String          @id @default(cuid())
  requesterId     String
  requester       User            @relation("SwapRequester", fields: [requesterId], references: [id])
  targetUserId    String
  targetUser      User            @relation("SwapTarget", fields: [targetUserId], references: [id])
  requesterShiftId String
  requesterShift   Schedule       @relation("RequesterShift", fields: [requesterShiftId], references: [id])
  targetShiftId    String
  targetShift      Schedule       @relation("TargetShift", fields: [targetShiftId], references: [id])
  status          ShiftSwapStatus @default(PENDING_TARGET)
  reason          String?         @db.Text
  targetResponse  String?         @db.Text
  reviewedById    String?
  reviewedBy      User?          @relation("SwapReviewer", fields: [reviewedById], references: [id])
  reviewedAt      DateTime?
  adminNotes      String?        @db.Text
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([requesterId, status])
  @@index([targetUserId, status])
  @@index([status])
}

// Admin-assigned tasks for dispatchers
model AdminTask {
  id           String    @id @default(cuid())
  title        String
  description  String?   @db.Text
  assignToAll  Boolean   @default(false)  // If true, assign to all dispatchers
  assignedToId String?                    // null if assignToAll=true
  assignedTo   User?     @relation("AdminTaskAssignee", fields: [assignedToId], references: [id])
  createdById  String
  createdBy    User      @relation("AdminTaskCreator", fields: [createdById], references: [id])
  isActive     Boolean   @default(true)
  priority     Int       @default(0)
  dueDate      DateTime?                  // Optional due date for the task
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Track completions by users
  completions  AdminTaskCompletion[]

  @@index([isActive, createdAt])
  @@index([assignedToId])
  @@index([dueDate])
}

// Track task completions per user
model AdminTaskCompletion {
  id          String    @id @default(cuid())
  taskId      String
  task        AdminTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  completedAt DateTime  @default(now())
  notes       String?   @db.Text  // Optional completion notes

  @@unique([taskId, userId])  // Each user can only complete a task once
  @@index([userId])
  @@index([taskId])
}

// Standard Operating Procedures (SOPs)
model SOP {
  id          String    @id @default(cuid())
  title       String
  slug        String    @unique // URL-friendly identifier
  description String?   @db.Text // Brief description shown in list
  content     String    @db.Text // Full SOP content (markdown supported)
  category    String?   // e.g., "Customer Service", "Operations", "Safety"
  isPublished Boolean   @default(true)
  order       Int       @default(0) // For manual ordering

  // Quick reference mode - condensed key steps
  quickReference String?  @db.Text

  // Acknowledgment required
  requiresAcknowledgment Boolean @default(false)

  // Creator/Editor
  createdById String
  createdBy   User      @relation(fields: [createdById], references: [id])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  reads       SOPRead[]
  favorites   SOPFavorite[]
  versions    SOPVersion[]
  relatedFrom SOPRelated[] @relation("RelatedFrom")
  relatedTo   SOPRelated[] @relation("RelatedTo")
  quiz        SOPQuiz?

  @@index([isPublished, order])
  @@index([category])
  @@index([slug])
}

// Track who has read/acknowledged an SOP
model SOPRead {
  id        String   @id @default(cuid())
  sopId     String
  sop       SOP      @relation(fields: [sopId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  readAt    DateTime @default(now())
  acknowledged Boolean @default(false)
  acknowledgedAt DateTime?

  @@unique([sopId, userId])
  @@index([sopId])
  @@index([userId])
}

// User favorites/bookmarks
model SOPFavorite {
  id        String   @id @default(cuid())
  sopId     String
  sop       SOP      @relation(fields: [sopId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@unique([sopId, userId])
  @@index([userId])
}

// Version history for SOPs
model SOPVersion {
  id          String   @id @default(cuid())
  sopId       String
  sop         SOP      @relation(fields: [sopId], references: [id], onDelete: Cascade)

  version     Int
  title       String
  content     String   @db.Text
  description String?  @db.Text
  quickReference String? @db.Text

  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])

  changeNote  String?
  createdAt   DateTime @default(now())

  @@unique([sopId, version])
  @@index([sopId])
}

// Link related SOPs together
model SOPRelated {
  id        String   @id @default(cuid())
  fromSopId String
  fromSop   SOP      @relation("RelatedFrom", fields: [fromSopId], references: [id], onDelete: Cascade)
  toSopId   String
  toSop     SOP      @relation("RelatedTo", fields: [toSopId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([fromSopId, toSopId])
  @@index([fromSopId])
  @@index([toSopId])
}

// Quiz for an SOP
model SOPQuiz {
  id        String   @id @default(cuid())
  sopId     String   @unique
  sop       SOP      @relation(fields: [sopId], references: [id], onDelete: Cascade)

  title     String?
  passingScore Int   @default(80)
  isActive  Boolean  @default(true)

  questions SOPQuizQuestion[]
  attempts  SOPQuizAttempt[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Quiz questions
model SOPQuizQuestion {
  id        String   @id @default(cuid())
  quizId    String
  quiz      SOPQuiz  @relation(fields: [quizId], references: [id], onDelete: Cascade)

  question  String   @db.Text
  options   String   @db.Text
  correctAnswer Int
  explanation String? @db.Text
  order     Int      @default(0)

  createdAt DateTime @default(now())

  @@index([quizId])
}

// Quiz attempts by users
model SOPQuizAttempt {
  id        String   @id @default(cuid())
  quizId    String
  quiz      SOPQuiz  @relation(fields: [quizId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  score     Int
  passed    Boolean
  answers   String   @db.Text

  startedAt  DateTime @default(now())
  completedAt DateTime?

  @@index([quizId])
  @@index([userId])
}
